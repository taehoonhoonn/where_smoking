# where_smoking 프로젝트 기획서

## 1. 프로젝트 개요

### 1.1 프로젝트 배경
- 국내 다중이용시설과 거리의 흡연 규제가 강화되면서, 합법적으로 흡연이 가능한 위치를 빠르게 확인하려는 수요가 급증하고 있다.
- 기존 지도 서비스는 흡연구역 데이터를 제공하지 않거나, 제공하더라도 행정구역별로 파편화되어 사용자 경험이 낮다.
- 공공데이터와 시민 제보를 결합해 최신성을 유지하고, 허위 제보를 걸러낼 수 있는 전문 지도 서비스가 요구된다.

### 1.2 프로젝트 목표
- **사용자 중심**: 현재 위치를 기준으로 인근 흡연구역을 즉시 탐색할 수 있는 웹 애플리케이션 구현.
- **데이터 신뢰성 확보**: 공공데이터, 시민 제보, 관리자 검수를 통해 최신·정확한 정보를 유지.
- **관리 편의성**: 관리자에게 검수, 승인, 삭제, 신고 처리 기능을 제공하여 데이터 품질을 통제 가능하게 한다.

### 1.3 기대 효과
- **흡연자**: 합법적인 흡연구역을 신속하게 확인하여 불필요한 이동 시간을 줄이고, 주민과의 마찰을 최소화.
- **비흡연자**: 금연구역 정보가 명확해져 간접흡연 피해 방지 및 민원 감소.
- **행정기관**: 흡연구역 운영 현황을 쉽게 파악해 정책 결정 및 인프라 확충에 활용 가능.

---

## 2. 시스템 아키텍처

### 2.1 전체 구성도
```
사용자 브라우저 → Flutter Web 앱 → Express REST API → PostgreSQL
                                    ↑
                             Python 데이터 파이프라인
```

### 2.2 주요 컴포넌트
| 컴포넌트 | 기술 | 주요 역할 |
| --- | --- | --- |
| 프론트엔드 | Flutter Web | 지도 UI, 현재 위치 처리, 마커 렌더링, 제보/신고, 관리자 화면 |
| 백엔드 | Node.js (Express) | REST API, 데이터 검증, 관리자 인증, 통계 |
| 데이터베이스 | PostgreSQL | 흡연구역, 제보, 신고 로그 저장 |
| 파이프라인 | Python 스크립트 | 공공데이터/제보 데이터 정제 및 삽입, 좌표 변환 |
| 지도 SDK | Naver Maps v3 | 지도 렌더링, 마커, InfoWindow |

### 2.3 환경 구성
- `.env`를 통해 API 키, DB 연결 정보 관리.
- Docker를 통한 배포를 고려하며, 로컬 환경에서도 동일한 구성으로 개발 가능.
- CI/CD (예: GitHub Actions)로 Lint/Test → Build → Deploy 파이프라인 구축 예정.

---

## 3. 기능 명세

### 3.1 사용자 기능
1. **자동 현재 위치 탐색**
   - 지도 탭 진입 시 브라우저 Geolocation을 호출하여 지도 중심을 현재 위치로 이동.
   - `/smoking-areas/nearby` API를 호출하여 반경 0.25~10km 내 흡연구역 표시.

2. **지도 상호작용**
   - 이동/줌 Idle 이벤트마다 뷰포트 정보를 Flutter로 전달, 필요 시 데이터 재요청.
   - InfoWindow를 통해 흡연구역 상세 정보(주소, 상세 설명, 신고 버튼) 제공.

3. **허위 제보 신고**
   - InfoWindow에 “허위 장소 신고” 버튼 배치, 신고 시 `report_count` 증가.
   - 신고 누적 건수는 관리자 화면에서 우선 검토 대상으로 표시.

4. **지도 조작 UI**
   - **새로고침 버튼**: 현재 뷰포트 기준으로 데이터 재로딩.
   - **현재 위치 버튼**: 다시 한 번 Geolocation으로 지도 중심 재설정.
   - **범례**: 공공데이터/시민제보 출처를 시각적으로 구분.

### 3.2 관리자 기능
- **관리자 토큰 기반 인증** (플러터 `config.js`, 백엔드 `.env`)
- **제보 승인/삭제**: 제보 데이터를 검토 후 승인 시 정식 데이터에 반영, 삭제 시 기록만 보존.
- **흡연구역 삭제**: 지도 InfoWindow에서 직접 삭제 가능.
- **신고 관리**: 허위 신고가 일정 횟수 이상이면 리스트에서 강조, 검토 후 삭제 여부 판단.

### 3.3 API 엔드포인트 (발췌)
| 메소드 | URL | 설명 |
| --- | --- | --- |
| GET | `/api/v1/smoking-areas` | 전체 흡연구역 목록 |
| GET | `/api/v1/smoking-areas/nearby` | 위도/경도/반경 기반 탐색 |
| POST | `/api/v1/smoking-areas/pending` | 시민 제보 등록 |
| PATCH | `/api/v1/smoking-areas/:id/approve` | 제보 승인 (관리자) |
| DELETE | `/api/v1/smoking-areas/:id` | 흡연구역 삭제 (관리자) |
| POST | `/api/v1/smoking-areas/:id/report` | 허위 신고 접수 |

---

## 4. 데이터 흐름 및 파이프라인

### 4.1 데이터 수집
- **공공데이터**: 지자체 공개 CSV/Excel → Python 스크립트로 정제 → DB 삽입.
- **시민 제보**: 플러터 앱에서 좌표/상세 입력 → `pending_smoking_areas` 테이블 저장.

### 4.2 변환/정제 단계
1. 원본 CSV → Pandas 처리: 중복 제거, 필수 필드 확인.
2. 주소 → 좌표 변환(카카오/네이버 API) 실패 건은 JSON 로그로 분리.
3. 좌표·주소 정규화를 마친 뒤, `replace` 또는 `append` 모드로 DB 반영.
4. 제보 데이터는 승인 전까지 `pending_smoking_areas`에 저장, 승인 시 `smoking_areas`로 이동.

### 4.3 데이터베이스 구조 (요약)
- `smoking_areas (id, category, address, detail, postal_code, latitude, longitude, report_count, status, created_at, updated_at)`
- `pending_smoking_areas (id, address, detail, latitude, longitude, status, created_at)`
- `false_reports (id, area_id, reason, created_at)` — 신고 내역 저장
- 추가로 히스토리/감사 로그 테이블을 고려 가능

---

## 5. 프론트엔드 구현 상세 (Flutter Web)

### 5.1 지도 뷰 로딩 흐름
1. `initState()`에서 지도 뷰 등록 및 JS 브리지 초기화.
2. `flutter_naver_map_loaded_*` 콜백이 불리면 `_currentViewId` 설정.
3. Geolocation 성공 시 지도 중심 이동 및 마커 요청.
4. `window.flutterRenderSmokingMarkers`에 마커 데이터를 전달해 지도에 표시.
5. Idle 이벤트로 뷰포트가 변하면 디바운싱 후 `_fetchAreasForViewport()` 호출.

### 5.2 마커 렌더링 (클러스터 비활성화)
- 마커와 InfoWindow는 JS에서 직접 생성.
- 시민제보 마커는 커스텀 SVG를 사용해 구분.
- InfoWindow에는 신고/삭제 버튼(IFF 관리자 토큰 보유) 포함.
- 지도 범위는 현재 렌더링된 마커를 기준으로 자동 조정.

### 5.3 관리자 UI (요약)
- 리스트 테이블: 주소, 날짜, 신고 건수, 승인/삭제 버튼.
- 승인/삭제 시 API 호출 후 상태바에 결과 메시지 표시, 리스트 갱신.
- 관리자 토글 버튼은 토큰 유무에 따라 활성화.

---

## 6. 백엔드 구현 상세 (Express)

### 6.1 미들웨어
- `helmet`, `cors`, `body-parser` 등 보안·편의 미들웨어.
- 모든 요청에 고유 `req.id`를 삽입해 로깅/트레이싱.

### 6.2 컨트롤러
- `SmokingAreaController.getNearbyAreas`:
  ```sql
  SELECT …
    FROM smoking_areas
   WHERE status = 'active'
     AND distance <= $3
   ORDER BY distance
   LIMIT $4
  ```
  - 하버사인 공식으로 거리 계산 후 필터링.

- `createPendingArea`/`approveArea`/`deleteArea`: 트랜잭션 처리로 데이터 정합성 보장.

### 6.3 데이터 모델
- ORM 대신 쿼리 함수를 직접 사용 (향후 Prisma/Knex 도입 고려).
- 다중 데이터 소스 필요 시, 추가 테이블 및 Foreign Key 설계로 확장 가능.

---

## 7. 테스트 및 품질 관리

### 7.1 자동화 테스트 (앞으로 구축 예정)
- **백엔드**: Jest + supertest로 컨트롤러, 라우터 통합 테스트.
- **프론트엔드**: flutter_test로 주요 위젯 테스트, 지도 인터랙션은 통합테스트에서 브라우저 자동화를 고려.
- **데이터 스크립트**: pytest 또는 unittest 기반으로 핵심 함수 검증.

### 7.2 수동 테스트 체크리스트
- 현재 위치 권한 허용/거부 시 지도 동작 확인.
- 지도 이동 → 데이터 재요청 시 마커 수가 정확히 변하는지.
- 허위 신고/제보 → 관리자 승인/삭제 플로우.
- 관리자 토큰이 없을 때 관리자 기능이 노출되지 않는지.

### 7.3 모니터링
- API 로깅을 클라우드 로깅(CloudWatch, Stackdriver 등)과 연계.
- 런타임 에러 추적을 위해 Sentry 등 프론트/백엔드 통합 모니터링 도입 고려.

---

## 8. 배포 전략 및 운영

### 8.1 환경 구분
- **로컬 개발**: Docker Compose로 DB + API + Flutter devserver.
- **스테이징**: 실데이터 일부를 masking 후 배포, QA 진행.
- **프로덕션**: CI/CD 파이프라인을 통해 릴리즈 자동화.

### 8.2 배포 파이프라인 (예시)
1. PR 생성 → Lint/Test 통과 확인.
2. main 브랜치 머지 → Docker 이미지 빌드 & Registry 푸시.
3. 스테이징 배포 → Smoke Test → 승인 후 프로덕션 배포.

### 8.3 운영 정책
- 인증/인가: 관리자 토큰 주기적 회전, 사용자 계정 시스템 도입 검토.
- 데이터 백업: PostgreSQL 백업 스케줄링, 제보/신고 데이터는 별도 저장소에 보관.
- 장애 대응: 지도 SDK 로딩 실패 시 기본 마커 모드, 데이터 API 오류 시 사용자 안내 메시지.

---

## 9. 향후 로드맵

### 9.1 기능 확장
- **클러스터링 재도입**: 안정적인 로딩 전략 마련 후 다시 활성화.
- **즐겨찾기/리스트 공유**: 자주 방문하는 장소 저장, URL 공유.
- **알림/구독**: 특정 지역의 새 흡연구역 추가 시 알림.
- **모바일 앱**: Flutter 앱을 iOS/Android로 빌드해 PWA 이상의 경험 제공.

### 9.2 기술 확장
- **PostGIS 연계**: 반경 검색, 공간 질의를 DB 레벨에서 고도화.
- **ElasticSearch/Redis**: 빠른 검색, 캐싱 도입.
- **AI 기반 이미지 검증**: 제보 사진 자동 분석 후 검수에 활용.

### 9.3 커뮤니티/운영
- 제보자 보상 시스템: 포인트, 등급 제도.
- 사용자 피드백 수집 채널(앱 내 설문, 커뮤니티 게시판).
- 지자체와의 협업을 통한 공식 데이터 피드.

---

## 10. 일정 및 리소스 계획 (예시)
| 단계 | 기간 | 산출물 |
| --- | --- | --- |
| 기획/요구사항 | 2주 | 기능 명세서, UX 와이어프레임 |
| 아키텍처 설계 | 1주 | 시스템 다이어그램, DB 설계 |
| 프론트 개발 | 4주 | 지도 화면, 관리자 화면, 테스트 코드 |
| 백엔드 개발 | 4주 | REST API, 인증, 통계 |
| 데이터 파이프라인 | 2주 | Python 스크립트, 샘플 데이터 로딩 |
| 통합 테스트/QS | 2주 | QA 보고서, 버그 수정 |
| 배포/안정화 | 1주 | 운영 매뉴얼, 모니터링 대시보드 |

*실제 일정은 팀 구성과 범위에 따라 조정 가능.*

---

## 11. 결론

where_smoking 프로젝트는 흡연 구역 정보에 특화된 지도 서비스를 구축함으로써, 사용자와 행정기관 모두에게 가치를 제공한다. 

Flutter Web을 통한 빠른 UI 개발, Node.js 기반의 유연한 API, Python 데이터 파이프라인 조합은 초기 구축뿐 아니라 향후 기능 확장에도 유리하다. 클러스터링, PostGIS 연계, 사용자 계정 시스템 등 추가 기능을 단계적으로 도입하면, 흡연구역 정보 플랫폼으로서의 경쟁력을 더욱 강화할 수 있다.

프로젝트 운영과정에서 사용자 피드백을 적극 반영하고, 데이터 품질 관리 프로세스를 고도화한다면, 궁극적으로 공공 서비스를 보완하는 실용적인 솔루션이 될 것이다.

