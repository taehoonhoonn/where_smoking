# Service Enhancement Implementation Plan

## Overview
사용자로부터 요청된 6개의 고도화 과제를 아래와 같이 분석했습니다. 1~5번은 지도/시민제보 UX 개선 및 관리자 모니터링 강화에 해당하고, 6번은 다국어(영문) 지원을 위한 구조 개편입니다. 본 문서는 각 과제를 어떻게 반영할지와 의존성, 위험 요소, 검증 방법을 정리합니다.

## 🎉 구현 상태 요약 (2025년 11월 업데이트)

**구현 완료율: 5/8 (63%)**

✅ **완료**: 좌표 노출 제거, 허위신고 관리자 기능, 신고 수 표시, 색상 구분, 마커 테두리 색상 수정
❌ **미완료**: 역지오코딩, 영어 모드, 지도 검색 기능, 필터 기능

### 주요 커밋 이력
- `d3f2f05` - 공식,비공식 컬러구분 (요구사항 5 완료)
- `6d46c9e` - 허위신고건수관리자확인기능추가 (요구사항 3 완료)
- `54464e0` - 시민제보좌표노출제거, 허위신고수노출반영 (요구사항 1, 4 완료)

## Requirement Breakdown & Proposed Approach

### 1. 시민제보 다이얼로그에서 좌표 노출 제거 ✅ **완료**
- **현황**: ~~`_showAddLocationDialog`와 `_showLocationDetailDialog`에 위/경도 텍스트가 그대로 표시됩니다.~~
- **변경안**: ~~사용자에게는 "선택한 위치" 정도의 안내만 보여주고 좌표는 숨깁니다. 추후 역지오코딩(요구사항 #2)으로 확보한 주소를 노출합니다.~~
- **구현 완료** (커밋 `54464e0`):
  1. ✅ 첫 번째 확인 AlertDialog에서 좌표 문자열 대신 "지도에서 선택한 위치" 문구로 교체 완료
  2. ✅ 상세 입력 다이얼로그에서도 좌표 제거 완료
- **검증 완료**: 지도 롱프레스 시 다이얼로그에서 좌표가 더 이상 표시되지 않음

### 2. 시민제보 주소 역지오코딩
- **현황**: `createPendingArea`가 주소를 `서울특별시 (lat, lng)`로 저장합니다.
- **라이브러리 검토**: Naver Maps JS 튜토리얼(Geocoder)과 Kakao Local `coord2address` REST API가 공식적으로 역지오코딩을 지원합니다. 현재 작업 환경은 외부 도큐먼트 접근이 제한되어 있어 링크를 직접 열람하진 못했으나, 제공해 주신 문서를 기준으로 `naver.maps.Service.reverseGeocode`를 활용하겠습니다. 필요 시 Kakao API를 백엔드 fallback으로 사용할 수 있도록 설계합니다.
- **선택안**: 프런트엔드(지도)에서 `naver.maps.Service.reverseGeocode`를 호출해 주소를 resolve한 뒤 API에 `resolved_address`를 함께 전송합니다. 실패 시 기존 포맷으로 폴백, 추후 서버에서 필요 시 Kakao API로 이중 확인 가능.
- **작업**:
  1. 지도 long-press 처리기에 역지오코딩 로직 추가 (성공 시 주소 상태 저장).
  2. `POST /smoking-areas/pending` 요청 body에 `address` 필드를 추가하고, 서버는 전달된 주소를 우선 저장하되 미제공 시 기존 포맷으로 대체.
  3. (선택) 백엔드에서 Kakao API를 호출해 주소를 검증/갱신하는 fallback 함수를 준비.
- **검증**: 시민제보 제출 후 `/smoking-areas` 응답에서 `address`가 실제 지번/도로명으로 기록되는지 확인.

### 3. 허위 신고 다건 리스트 (관리자용) ✅ **완료**
- **현황**: ~~`reportFalseArea`가 `report_count`를 증가시키지만, 관리자 UI에 해당 목록이나 정렬 옵션이 없습니다.~~
- **구현 완료** (커밋 `6d46c9e`):
  - ✅ API: `GET /api/v1/smoking-areas/reported` 관리자 전용 엔드포인트 구현
  - ✅ `report_count > 0`인 항목을 `report_count DESC, updated_at DESC`로 정렬하여 반환
  - ✅ Flutter: `AdminScreen`에 2개 탭 구조 구현 (대기 신청 / 신고 목록)
  - ✅ 신고 많은 순으로 카드형 리스트 표시
- **검증 완료**: 허위 신고 후 관리자 화면 "신고 목록" 탭에서 신고 수 순으로 정렬되어 표시됨

### 4. InfoWindow에 허위 신고 수 노출 ✅ **완료**
- **현황**: ~~InfoWindow 버튼은 "허위 장소 신고하기"만 노출되고, 신고 횟수는 UI에 나오지 않습니다.~~
- **구현 완료** (커밋 `54464e0`):
  1. ✅ Dart에서 `report_count`를 InfoWindow payload에 포함하도록 수정
  2. ✅ InfoWindow에 신고 횟수 표시 기능 구현
  3. ✅ 신고 수가 0이면 숨김 처리
- **검증 완료**: 신고 수가 있는 마커 클릭 시 InfoWindow에 "허위 신고 N회" 텍스트 표시됨

### 5. 시민제보 핀 색상 분리 + 범례 업데이트 ✅ **완료**
- **현황**: ~~시민제보 전용 마커 SVG가 하나뿐이며, `submitted_category`(공식/비공식)가 시각적으로 구분되지 않습니다. 범례에도 해당 정보가 없음.~~
- **구현 완료** (커밋 `d3f2f05`):
  - ✅ **컬러 팔레트 적용**:
    - 공식 시민제보: 진한 초록색 `#16A34A`
    - 비공식 시민제보: 노란색 `#FACC15` (기존 유지)
  - ✅ `flutter_marker_renderer.js`에서 `submitted_category`에 따른 색상 분기 처리 구현
  - ✅ `MapScreen._buildLegendChips`에 두 종류의 시민제보 범례 추가
- **검증 완료**: 시민제보 시 선택한 유형(공식/비공식)에 따라 지도에서 다른 색상으로 표시되고 범례도 업데이트됨

### 6. 영어 모드
- **범위**: 전체 Flutter UI(지도 안내, 시민제보 다이얼로그, 관리자 화면, API 테스트 탭 등)와 InfoWindow/Toast 문구. 백엔드 응답 메시지는 우선순위 밖.

### 7. 지도 검색 기능 ⭐ **신규 추가**
- **현황**: 현재 지도에서 장소나 주소를 검색하는 기능이 없어 사용자가 원하는 위치로 이동하기 어려움
- **요구사항**:
  - 네이버 지도 앱과 같은 상단 검색바 UI 구현
  - 실시간 자동완성 검색 결과 표시 (드롭다운 리스트)
  - 장소명/주소 통합 검색 (예: "ST타워", "강남역", "서울시 중구 태평로")
  - 검색 결과 선택 시 해당 위치로 지도 이동 및 마커 표시
- **기술 구현안**:
  - **카카오 Local API** 활용 (네이버 Places API 서비스 종료로 인해)
  - API 프록시: 백엔드에 `GET /api/v1/places/search?query=검색어&x=경도&y=위도` 엔드포인트 추가
  - Flutter: TextField with debouncing (300ms) + 자동완성 드롭다운
  - 검색 결과를 네이버 지도 좌표계로 변환 후 지도 이동
- **검증**: "강남역", "롯데타워" 등 다양한 키워드로 검색 후 정확한 위치 이동 확인

### 8. 흡연구역 필터 기능 ⭐ **신규 추가**
- **현황**: 현재 모든 흡연구역이 지도에 표시되어 사용자가 원하는 유형만 보기 어려움
- **요구사항**:
  - 기존 좌측 하단 범례를 클릭 가능한 필터로 전환
  - 카테고리별 필터: 공공데이터 / 공식 시민제보 / 비공식 시민제보
  - 각 범례 항목 클릭 시 해당 마커 토글 (보이기/숨기기)
  - 필터 적용 시 실시간 지도 마커 업데이트
- **UI 구현안**:
  - 현재 범례 칩(Chip) UI를 버튼으로 변경
  - 활성화된 필터는 색상 강조, 비활성화된 필터는 반투명 처리
  - 각 범례 항목에 체크 상태 표시 (아이콘 또는 색상 변경)
- **기술 구현**:
  - Flutter에서 필터 상태 관리 (Set<String> activeFilters)
  - 마커 렌더링 시 필터 조건에 따라 표시/숨김 처리
  - API 호출 최적화: 모든 데이터를 받아서 클라이언트에서 필터링
- **검증**: 각 범례 클릭 후 해당 유형 마커만 표시되는지 확인
- **아키텍처 제안**:
  1. Flutter의 `MaterialApp`에 `locale`, `supportedLocales`, `localizationsDelegates`를 설정. `flutter_localizations` + `intl` 패키지 사용.
  2. `l10n/` 디렉터리에 `arb` 파일(`app_ko.arb`, `app_en.arb`)을 추가하고 `flutter gen-l10n`으로 `AppLocalizations` 생성.
  3. 앱 내 문자열을 전부 `AppLocalizations.of(context)` 참조로 치환.
  4. 메인 화면에 언어 토글 UX(예: AppBar IconButton 혹은 설정 드로워) 추가하고, 선택값을 `SharedPreferences` 또는 `localStorage`에 저장해 다음 진입 시 유지.
  5. InfoWindow/JS 문자열(허위 신고 버튼 등)은 JS 템플릿을 두 언어로 제공하거나 Dart에서 전달될 텍스트를 인자로 넘기도록 구조 변경 필요.
- **검증 전략**: QA 동안 언어 토글 → 모든 화면 전환마다 문자열 반영 여부 확인, 영어 모드에서 시민제보/관리자 흐름 정상 동작 확인.
- **리스크**: 문자열 분리 작업량이 큼, InfoWindow(순수 HTML 문자열) 번역 동기화 필요, JS-Dart간 다국어 전달 로직 추가. 네이버 지도 JS에서 자체 언어 모드를 설정하려면 공식 튜토리얼(Map Language)을 따라야 하므로, `map.setOptions({ language: 'en' })`(예시) 등 문서 기반 설정을 적용할 계획입니다. 현재 네트워크 제한으로 문서를 직접 확인할 수 없어, 실제 구현 시 제공해주신 링크를 기반으로 옵션을 반영하겠습니다.

## Work Plan & Dependencies

### ✅ Phase 1 – UX & Data Quality (요구사항 1, 3, 4, 5) **완료**
1. ~~**Reverse Geocoding Helper 작성**: Naver JS `reverseGeocode` 래퍼 + fallback HTTP 호출 설계.~~ ❌ **미완료**
2. ✅ **시민제보 다이얼로그 개선**: 좌표 제거 완료 (커밋 `54464e0`)
3. ✅ **API 업데이트**:
   - ✅ 새 관리자용 라우트 `/smoking-areas/reported` 추가 완료
   - ✅ `GET /smoking-areas` / `nearby` 응답에 `submitted_category`와 `report_count` 포함 확인
4. ✅ **Flutter 지도/관리자 UI 수정**:
   - ✅ 시민제보 마커 색상 분기, 범례 갱신 완료 (커밋 `d3f2f05`)
   - ✅ InfoWindow HTML에 신고 횟수 표기 완료 (커밋 `54464e0`)
   - ✅ 관리자 화면에 신고순 리스트 완료 (커밋 `6d46c9e`)
5. ✅ **테스트**: 시민제보 → 승인/신고 → 관리자 뷰 검증 완료

### 📝 남은 작업 (요구사항 2, 6, 7, 8)
- ❌ **요구사항 2**: 시민제보 주소 역지오코딩 (Naver Maps API 연동)
- ❌ **요구사항 6**: 영어 모드 구현 (Flutter intl + l10n 설정)
- ❌ **요구사항 7**: 지도 검색 기능 (카카오 Local API + 자동완성)
- ❌ **요구사항 8**: 흡연구역 필터 기능 (카테고리별/신고별 필터링)

### Phase 2 – Search & Filter Features (요구사항 7, 8) **우선순위 높음**
1. **카카오 Local API 연동**:
   - 백엔드에 프록시 엔드포인트 추가: `GET /api/v1/places/search`
   - 카카오 API 키워드 검색 연동 및 좌표 변환
2. **지도 검색바 UI 구현**:
   - MapScreen 상단에 검색 TextField 추가
   - 실시간 자동완성 드롭다운 리스트 구현
   - 검색 결과 선택 시 지도 이동 + 임시 마커 표시
3. **범례 필터 기능 구현**:
   - 기존 범례 칩을 클릭 가능한 필터 버튼으로 전환
   - 카테고리별 토글: 공공데이터/공식 시민제보/비공식 시민제보
   - 클라이언트 사이드 필터링으로 실시간 마커 업데이트

### Phase 3 – Localization & Advanced Features (요구사항 2, 6)
1. **역지오코딩 구현**: Naver Maps API 연동으로 시민제보 주소 자동 해석
2. **영어 모드 구현**:
   - `l10n` 셋업 및 문자열 분리 계획 수립
   - 핵심 화면별 텍스트 치환 및 언어 토글 UX 구현
   - JS 인터롭/InfoWindow 텍스트를 다국어화하기 위한 데이터 포맷 정리
   - QA: 언어 전환 시 지도/다이얼로그/관리자/API 테스트 화면이 모두 번역되는지 확인

## ✅ Resolved Questions
- ✅ **시민제보 핀 색상 팔레트**: 공식 `#16A34A` (진한 초록), 비공식 `#FACC15` (노란색) 구현 완료
- ✅ **신고순 리스트 UI**: 관리자 화면에 2개 탭 구조로 구현 완료 (대기 신청 / 신고 목록)

## 🔄 Remaining Questions / Next Steps
- **역지오코딩**: Naver JS API 활용 (브라우저 내) 방식으로 진행 예정, 필요 시 Kakao REST API 백업 검토
- **영어 모드**: 한국어/영어 2개 언어 우선 구현, 향후 확장성 고려한 구조 설계

---
**현재 상태**: Phase 1의 5개 요구사항 완료, Phase 2-3의 3개 요구사항 남음 (구현 완료율 63%)

**다음 우선순위**: Phase 2 (검색 & 필터 기능) → Phase 3 (역지오코딩 & 다국어)
