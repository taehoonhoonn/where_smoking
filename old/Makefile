# í¡ì—°êµ¬ì—­ ì°¾ê¸° ì•± Docker ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸

.PHONY: help build up down logs clean restart db-import test

# ê¸°ë³¸ íƒ€ê²Ÿ
help:
	@echo "ğŸš¬ í¡ì—°êµ¬ì—­ ì°¾ê¸° ì•± Docker ê´€ë¦¬ ëª…ë ¹ì–´"
	@echo ""
	@echo "ğŸ“‹ ì£¼ìš” ëª…ë ¹ì–´:"
	@echo "  make up         - ì „ì²´ ì„œë¹„ìŠ¤ ì‹œì‘"
	@echo "  make down       - ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€"
	@echo "  make restart    - ì „ì²´ ì„œë¹„ìŠ¤ ì¬ì‹œì‘"
	@echo "  make logs       - ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸"
	@echo "  make build      - Docker ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo ""
	@echo "ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤:"
	@echo "  make db-import  - í¡ì—°êµ¬ì—­ ë°ì´í„° ì„í¬íŠ¸"
	@echo "  make db-backup  - ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…"
	@echo "  make db-restore - ë°ì´í„°ë² ì´ìŠ¤ ë³µì›"
	@echo ""
	@echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ê´€ë¦¬:"
	@echo "  make test       - API í…ŒìŠ¤íŠ¸"
	@echo "  make clean      - ëª¨ë“  ì»¨í…Œì´ë„ˆ/ë³¼ë¥¨ ì œê±°"
	@echo "  make status     - ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"

# Docker Compose ëª…ë ¹ì–´ë“¤
up:
	@echo "ğŸš€ í¡ì—°êµ¬ì—­ ì°¾ê¸° ì•± ì‹œì‘ ì¤‘..."
	docker-compose up -d
	@echo "âœ… ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ!"
	@echo "ğŸŒ API ì„œë²„: http://localhost:3000"
	@echo "ğŸ—„ï¸  pgAdmin: http://localhost:8080 (admin@smoking-areas.com / admin123)"
	@make status

down:
	@echo "ğŸ›‘ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
	docker-compose down
	@echo "âœ… ì„œë¹„ìŠ¤ ì¤‘ì§€ ì™„ë£Œ!"

restart:
	@echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
	docker-compose restart
	@echo "âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ!"

build:
	@echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker-compose build
	@echo "âœ… ë¹Œë“œ ì™„ë£Œ!"

logs:
	@echo "ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸ (Ctrl+Cë¡œ ì¢…ë£Œ)"
	docker-compose logs -f

status:
	@echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
	@docker-compose ps

# ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬
db-import:
	@echo "ğŸ’¾ í¡ì—°êµ¬ì—­ ë°ì´í„° ì„í¬íŠ¸ ì¤‘..."
	@echo "â³ PostgreSQL ì¤€ë¹„ ëŒ€ê¸°..."
	@sleep 5
	docker exec -it smoking_areas_db psql -U postgres -d smoking_areas_db -c "SELECT 'Database ready' as status;"
	@echo "ğŸ“Š Python ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°ì´í„° ì„í¬íŠ¸..."
	cd scripts && python3 database_manager.py setup
	@echo "âœ… ë°ì´í„° ì„í¬íŠ¸ ì™„ë£Œ!"

db-backup:
	@echo "ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì¤‘..."
	docker exec smoking_areas_db pg_dump -U postgres smoking_areas_db > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… ë°±ì—… ì™„ë£Œ!"

db-restore:
	@echo "ğŸ“¥ ë°ì´í„°ë² ì´ìŠ¤ ë³µì› ì¤‘..."
	@read -p "ë°±ì—… íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”: " backup_file; \
	docker exec -i smoking_areas_db psql -U postgres smoking_areas_db < $$backup_file
	@echo "âœ… ë³µì› ì™„ë£Œ!"

# í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹…
test:
	@echo "ğŸ§ª API í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	@echo "ğŸ“¡ í—¬ìŠ¤ì²´í¬..."
	curl -f http://localhost:3000/api/v1/health || echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
	@echo ""
	@echo "ğŸ“Š í†µê³„ ì¡°íšŒ..."
	curl -f http://localhost:3000/api/v1/smoking-areas/statistics || echo "âŒ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨"
	@echo ""
	@echo "ğŸ—ºï¸  ì£¼ë³€ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸..."
	curl -f "http://localhost:3000/api/v1/smoking-areas/nearby?lat=37.5547&lng=126.9707&radius=1000" || echo "âŒ ì£¼ë³€ ê²€ìƒ‰ ì‹¤íŒ¨"
	@echo ""
	@echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

# ì •ë¦¬ ì‘ì—…
clean:
	@echo "âš ï¸  ëª¨ë“  ì»¨í…Œì´ë„ˆì™€ ë³¼ë¥¨ì„ ì œê±°í•©ë‹ˆë‹¤!"
	@read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker-compose down -v --remove-orphans; \
		docker system prune -f; \
		echo "âœ… ì •ë¦¬ ì™„ë£Œ!"; \
	else \
		echo "âŒ ì·¨ì†Œë¨"; \
	fi

# ê°œë°œìš© ë‹¨ì¶• ëª…ë ¹ì–´
dev: up db-import
	@echo "ğŸ‰ ê°œë°œ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!"
	@echo "ğŸ“ ë‹¤ìŒ ëª…ë ¹ì–´ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:"
	@echo "  make logs    - ë¡œê·¸ í™•ì¸"
	@echo "  make test    - API í…ŒìŠ¤íŠ¸"
	@echo "  make restart - ì„œë¹„ìŠ¤ ì¬ì‹œì‘"

# í”„ë¡œë•ì…˜ ë¹Œë“œ
prod:
	@echo "ğŸ­ í”„ë¡œë•ì…˜ í™˜ê²½ ë¹Œë“œ ì¤‘..."
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
	@echo "âœ… í”„ë¡œë•ì…˜ í™˜ê²½ ì‹œì‘ ì™„ë£Œ!"